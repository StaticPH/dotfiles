#! /usr/bin/bash

## Only use this with WSL.
if ! command grep -qe Microsoft -e WSL2 /proc/version; then
	tput setaf 1
	echo "Abort: You probably don't actually want to do this, given you don't appear to be in WSL."
	tput sgr0
	exit 1
fi

if [ "$(id -u)" -ne 0 ]; then
	echo 'Requesting elevated permissions in order to update clock...'
	sudo -v
fi

getTimeFromPS(){
	pushd /mnt/c >/dev/null 2>&1 # See THIS insanity: https://github.com/microsoft/WSL/issues/6170
	# Works for Powershell v5.1
	powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; [Console]::InputEncoding = [System.Text.Encoding]::UTF8; (Get-Date).ToUniversalTime()" 
# 	powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command \
# 	"[Console]::OutputEncoding = [System.Text.Encoding]::UTF8; [Console]::InputEncoding = [System.Text.Encoding]::UTF8; $*" \
# 	'(Get-Date).ToUniversalTime()'
	popd >/dev/null 2>&1
}

now(){ date -d now; }

printf 'Adjusting from: %s\n' "$(now)"

printf '%s' 'Native Windows host reports time as '
sudo date -u -s "$(getTimeFromPS)"

printf 'Time synced to: %s\n' "$(now)"
